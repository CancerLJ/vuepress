<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>日志统计JSSDK示例 | 喵巨人笔记</title>
    <meta name="description" content="喵巨人学习笔记，包含前端开发、后端开发、服务器运维等">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.737906f3.css" as="style"><link rel="preload" href="/assets/js/app.373ebcd7.js" as="script"><link rel="preload" href="/assets/js/3.bfdcfffd.js" as="script"><link rel="preload" href="/assets/js/46.15edd465.js" as="script"><link rel="prefetch" href="/assets/js/1.2bae9d15.js"><link rel="prefetch" href="/assets/js/10.c7e5de1e.js"><link rel="prefetch" href="/assets/js/11.947faf55.js"><link rel="prefetch" href="/assets/js/12.2472fbdd.js"><link rel="prefetch" href="/assets/js/13.9e618bf6.js"><link rel="prefetch" href="/assets/js/14.0356e7d9.js"><link rel="prefetch" href="/assets/js/15.3c111c61.js"><link rel="prefetch" href="/assets/js/16.b9482d17.js"><link rel="prefetch" href="/assets/js/17.98b647f1.js"><link rel="prefetch" href="/assets/js/18.76c49e99.js"><link rel="prefetch" href="/assets/js/19.1c20d10f.js"><link rel="prefetch" href="/assets/js/20.dc70c8fc.js"><link rel="prefetch" href="/assets/js/21.467ebb2d.js"><link rel="prefetch" href="/assets/js/22.b0a1d0f3.js"><link rel="prefetch" href="/assets/js/23.b00a4bf6.js"><link rel="prefetch" href="/assets/js/24.ca272cf3.js"><link rel="prefetch" href="/assets/js/25.14adbaf7.js"><link rel="prefetch" href="/assets/js/26.f97564e3.js"><link rel="prefetch" href="/assets/js/27.8e4bdef8.js"><link rel="prefetch" href="/assets/js/28.82f93745.js"><link rel="prefetch" href="/assets/js/29.987f527d.js"><link rel="prefetch" href="/assets/js/30.b00d5021.js"><link rel="prefetch" href="/assets/js/31.0373fca1.js"><link rel="prefetch" href="/assets/js/32.f4b40012.js"><link rel="prefetch" href="/assets/js/33.befd342c.js"><link rel="prefetch" href="/assets/js/34.db1e4f82.js"><link rel="prefetch" href="/assets/js/35.738f4fb7.js"><link rel="prefetch" href="/assets/js/36.06c6d04e.js"><link rel="prefetch" href="/assets/js/37.984d486d.js"><link rel="prefetch" href="/assets/js/38.b68b4bc8.js"><link rel="prefetch" href="/assets/js/39.58b551b7.js"><link rel="prefetch" href="/assets/js/4.730b44f6.js"><link rel="prefetch" href="/assets/js/40.e430db82.js"><link rel="prefetch" href="/assets/js/41.e9743d5e.js"><link rel="prefetch" href="/assets/js/42.3971888d.js"><link rel="prefetch" href="/assets/js/43.656a7310.js"><link rel="prefetch" href="/assets/js/44.9fa3cf39.js"><link rel="prefetch" href="/assets/js/45.cd770c5b.js"><link rel="prefetch" href="/assets/js/47.3e4c8435.js"><link rel="prefetch" href="/assets/js/48.20578371.js"><link rel="prefetch" href="/assets/js/49.16e33620.js"><link rel="prefetch" href="/assets/js/5.34ad1117.js"><link rel="prefetch" href="/assets/js/50.342ff260.js"><link rel="prefetch" href="/assets/js/51.521f5e9b.js"><link rel="prefetch" href="/assets/js/52.6a76ec0a.js"><link rel="prefetch" href="/assets/js/53.69444c3a.js"><link rel="prefetch" href="/assets/js/54.07b58fd5.js"><link rel="prefetch" href="/assets/js/55.8f53b56c.js"><link rel="prefetch" href="/assets/js/56.19c3bd08.js"><link rel="prefetch" href="/assets/js/57.73b77cef.js"><link rel="prefetch" href="/assets/js/58.736d163d.js"><link rel="prefetch" href="/assets/js/59.260f8893.js"><link rel="prefetch" href="/assets/js/6.7846ba7f.js"><link rel="prefetch" href="/assets/js/60.31913508.js"><link rel="prefetch" href="/assets/js/61.044fc743.js"><link rel="prefetch" href="/assets/js/62.e1cdd68a.js"><link rel="prefetch" href="/assets/js/63.46360f15.js"><link rel="prefetch" href="/assets/js/64.97176203.js"><link rel="prefetch" href="/assets/js/65.2103cfda.js"><link rel="prefetch" href="/assets/js/66.9a7763c9.js"><link rel="prefetch" href="/assets/js/67.1c1bc12c.js"><link rel="prefetch" href="/assets/js/68.ec583a59.js"><link rel="prefetch" href="/assets/js/69.dc6b9224.js"><link rel="prefetch" href="/assets/js/7.2d505d86.js"><link rel="prefetch" href="/assets/js/70.6720396d.js"><link rel="prefetch" href="/assets/js/71.649f88b5.js"><link rel="prefetch" href="/assets/js/72.fd020fed.js"><link rel="prefetch" href="/assets/js/73.1a58133e.js"><link rel="prefetch" href="/assets/js/74.ce0c5fdf.js"><link rel="prefetch" href="/assets/js/75.10bc575a.js"><link rel="prefetch" href="/assets/js/76.c28e2c30.js"><link rel="prefetch" href="/assets/js/77.4fecac7f.js"><link rel="prefetch" href="/assets/js/78.35acfd0c.js"><link rel="prefetch" href="/assets/js/79.8d634081.js"><link rel="prefetch" href="/assets/js/8.80a2de5f.js"><link rel="prefetch" href="/assets/js/80.fc226694.js"><link rel="prefetch" href="/assets/js/81.ae543107.js"><link rel="prefetch" href="/assets/js/82.336196da.js"><link rel="prefetch" href="/assets/js/83.92783483.js"><link rel="prefetch" href="/assets/js/84.6b5d6b7b.js"><link rel="prefetch" href="/assets/js/85.96cb4fa9.js"><link rel="prefetch" href="/assets/js/86.ccb3db59.js"><link rel="prefetch" href="/assets/js/87.dd5a823e.js"><link rel="prefetch" href="/assets/js/9.e7a537d5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.737906f3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">喵巨人笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端开发</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/前端开发/css/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/前端开发/javascript/" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/前端开发/vue/" class="nav-link">vue</a></li><li class="dropdown-item"><!----> <a href="/前端开发/nuxt/" class="nav-link">nuxt</a></li><li class="dropdown-item"><!----> <a href="/前端开发/插件/" class="nav-link">插件</a></li><li class="dropdown-item"><!----> <a href="/前端开发/other/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><a href="/php/" class="nav-link">php</a></div><div class="nav-item"><a href="/linux/" class="nav-link">linux</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/其他/Markdown简介.html" class="nav-link">Markdown简介</a></li></ul></div></div><div class="nav-item"><a href="/关于作者.html" class="nav-link">关于</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端开发</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/前端开发/css/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/前端开发/javascript/" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/前端开发/vue/" class="nav-link">vue</a></li><li class="dropdown-item"><!----> <a href="/前端开发/nuxt/" class="nav-link">nuxt</a></li><li class="dropdown-item"><!----> <a href="/前端开发/插件/" class="nav-link">插件</a></li><li class="dropdown-item"><!----> <a href="/前端开发/other/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><a href="/php/" class="nav-link">php</a></div><div class="nav-item"><a href="/linux/" class="nav-link">linux</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/其他/Markdown简介.html" class="nav-link">Markdown简介</a></li></ul></div></div><div class="nav-item"><a href="/关于作者.html" class="nav-link">关于</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>日志统计JSSDK示例</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/other/%E6%97%A5%E5%BF%97%E7%BB%9F%E8%AE%A1JSSDK%E7%A4%BA%E4%BE%8B.html#需求" class="sidebar-link">需求</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/other/%E6%97%A5%E5%BF%97%E7%BB%9F%E8%AE%A1JSSDK%E7%A4%BA%E4%BE%8B.html#实现" class="sidebar-link">实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/other/%E6%97%A5%E5%BF%97%E7%BB%9F%E8%AE%A1JSSDK%E7%A4%BA%E4%BE%8B.html#命名空间" class="sidebar-link">命名空间</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/other/%E6%97%A5%E5%BF%97%E7%BB%9F%E8%AE%A1JSSDK%E7%A4%BA%E4%BE%8B.html#产品区分" class="sidebar-link">产品区分</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/other/%E6%97%A5%E5%BF%97%E7%BB%9F%E8%AE%A1JSSDK%E7%A4%BA%E4%BE%8B.html#发送请求" class="sidebar-link">发送请求</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/other/%E6%97%A5%E5%BF%97%E7%BB%9F%E8%AE%A1JSSDK%E7%A4%BA%E4%BE%8B.html#参数处理" class="sidebar-link">参数处理</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/other/%E6%97%A5%E5%BF%97%E7%BB%9F%E8%AE%A1JSSDK%E7%A4%BA%E4%BE%8B.html#页面类型" class="sidebar-link">页面类型</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/other/%E6%97%A5%E5%BF%97%E7%BB%9F%E8%AE%A1JSSDK%E7%A4%BA%E4%BE%8B.html#自动采集" class="sidebar-link">自动采集</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/other/%E6%97%A5%E5%BF%97%E7%BB%9F%E8%AE%A1JSSDK%E7%A4%BA%E4%BE%8B.html#埋点功能" class="sidebar-link">埋点功能</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/other/%E6%97%A5%E5%BF%97%E7%BB%9F%E8%AE%A1JSSDK%E7%A4%BA%E4%BE%8B.html#开放方法" class="sidebar-link">开放方法</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/other/%E6%97%A5%E5%BF%97%E7%BB%9F%E8%AE%A1JSSDK%E7%A4%BA%E4%BE%8B.html#压缩混淆" class="sidebar-link">压缩混淆</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="日志统计jssdk示例"><a href="#日志统计jssdk示例" aria-hidden="true" class="header-anchor">#</a> 日志统计JSSDK示例</h1> <h2 id="需求"><a href="#需求" aria-hidden="true" class="header-anchor">#</a> 需求</h2> <p>类似于百度统计。
实现简单的前端访问等采集功能</p> <blockquote><p>两个功能：</p> <ul><li>打开页面、离开页面的自动采集功能</li> <li>前端埋点，通过代码中埋点采集数据</li></ul></blockquote> <blockquote><p>前端需要保证</p> <ol><li>用户无感知：异步方式处理，不影响用户的业务接口访问</li> <li>通用性：应能适用原生环境和各类框架集成环境，如VUE、reactjs, angular等</li> <li>轻量：压缩</li> <li>加密：代码本身需要做混淆处理，特别是要将参数混淆，尽量隐藏处理过程和接口细节</li> <li>安全：为了保证通信安全，接口调用尽量走ssl</li></ol></blockquote> <h2 id="实现"><a href="#实现" aria-hidden="true" class="header-anchor">#</a> 实现</h2> <h3 id="命名空间"><a href="#命名空间" aria-hidden="true" class="header-anchor">#</a> 命名空间</h3> <p>为防止<code>js</code>文件对项目命名的污染，把代码放在一个自执行函数中</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// sdkLog.js文件</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// do something</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="产品区分"><a href="#产品区分" aria-hidden="true" class="header-anchor">#</a> 产品区分</h3> <p>我们通过给<code>js</code>文件带<code>key</code>值的方式来区分产品。不同的产品对应着不同的<code>key</code>值</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// html文件</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> sdk <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;script&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  sdk<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;http://xxx/sdkLog.js?xxxxxxxxxxxxx&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> s <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">&quot;script&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
  s<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>sdk<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment">// sdkLog.js文件</span>
<span class="token keyword">function</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// let file, scripts = document.getElementsByTagName(&quot;script&quot;); </span>
  <span class="token comment">// file = scripts[scripts.length - 1].getAttribute(&quot;src&quot;);</span>
  <span class="token comment">// console.log(file)</span>
  <span class="token keyword">let</span> curScriptElement <span class="token operator">=</span> document<span class="token punctuation">.</span>currentScript
  <span class="token keyword">let</span> arySrc <span class="token operator">=</span> curScriptElement<span class="token punctuation">.</span>src<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>arySrc<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> arySrc<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>以后可能会给<code>js</code>文件带更多的参数，我们采用<code>key1=value1&amp;key2=value2</code>的形式</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// html文件</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> sdk <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;script&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  sdk<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;http://xxx/sdkLog.js?key=xxxxxxxxxxxxx&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> s <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">&quot;script&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
  s<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>sdk<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment">// sdkLog.js文件</span>
<span class="token keyword">function</span> <span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// let file, scripts = document.getElementsByTagName(&quot;script&quot;); </span>
  <span class="token comment">// file = scripts[scripts.length - 1].getAttribute(&quot;src&quot;);</span>
  <span class="token comment">// console.log(file)</span>
  <span class="token keyword">let</span> curScriptElement <span class="token operator">=</span> document<span class="token punctuation">.</span>currentScript
  <span class="token keyword">let</span> arySrc <span class="token operator">=</span> curScriptElement<span class="token punctuation">.</span>src<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>arySrc<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> aryResult <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">let</span> aryParam <span class="token operator">=</span> arySrc<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>aryParam<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> aryParam<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> data <span class="token operator">=</span> aryParam<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span>
      aryResult<span class="token punctuation">[</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> aryResult
<span class="token punctuation">}</span>
<span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'key'</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="发送请求"><a href="#发送请求" aria-hidden="true" class="header-anchor">#</a> 发送请求</h3> <p>前端采集到数据后，需要往后端发送接口请求，将采集到的数据发送给后端
一般发送接口请求都是采用<code>ajax</code>
如果使用<code>ajax</code>的话。为保证通用性，我们需要自己自己封装<code>ajax</code>
这里我们不需要关心接口请求的返回值等，只要发送出去就可以。用<code>Get</code>请求。我们采用<code>new Image()</code>的方式</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// sdkLog.js文件</span>
<span class="token keyword">function</span> <span class="token function">sendImg</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  img<span class="token punctuation">.</span>src <span class="token operator">=</span> url
  <span class="token keyword">return</span> img
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="参数处理"><a href="#参数处理" aria-hidden="true" class="header-anchor">#</a> 参数处理</h3> <p>发送的请求数据需要处理成<code>key1=value1&amp;key2=value2</code>的形式
我们封装一个方法用来处理</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">formatParams</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> k <span class="token keyword">in</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key <span class="token operator">+</span> <span class="token string">'='</span> <span class="token operator">+</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res <span class="token operator">=</span> <span class="token string">'?'</span> <span class="token operator">+</span> arr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="页面类型"><a href="#页面类型" aria-hidden="true" class="header-anchor">#</a> 页面类型</h3> <p>判断下页面类型<code>app</code>、<code>wechat</code>、<code>qq</code>、<code>openweb</code></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getBrowserType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ua <span class="token operator">=</span> navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ua<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/micromessenger/i</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'wechat'</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ua<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/\sqq\//i</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'qq'</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ua<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/mobile/i</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> ua<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/browser/i</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 页面是不是运行在某个APP内部，这个需要根据实际情况判断</span>
    <span class="token comment">// APP可以在userAgent中添加特定的标识用来区分</span>
    <span class="token comment">// APP也可以自动加一些参数来区分</span>
    <span class="token comment">// 总之根据实际情况</span>
    <span class="token comment">// 这里只是随便加了一个判断（比如有 mobile 标识，没有 browser 标识）</span>
    <span class="token keyword">return</span> <span class="token string">'app'</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'openweb'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="自动采集"><a href="#自动采集" aria-hidden="true" class="header-anchor">#</a> 自动采集</h3> <blockquote><p>参数</p> <ul><li><code>url</code>：页面地址</li> <li><code>act</code>：行为（<code>open</code>、<code>refresh</code>、<code>redirection</code>、<code>close</code>）</li> <li><code>duration</code>：滞留时间，打开的话传<code>0</code></li> <li><code>key</code>：产品代号</li> <li><code>m</code>：相同地址的图片会有缓存，为保证每次都能发出请求，多加一个参数。用随机数或者当前时间</li></ul></blockquote> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// sdkLog.js文件</span>
<span class="token keyword">let</span> baseApi <span class="token operator">=</span> <span class="token string">'https://xxxx/api/'</span>
<span class="token keyword">let</span> startTime <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'key'</span><span class="token punctuation">]</span>
<span class="token keyword">function</span> <span class="token function">sendAuto</span><span class="token punctuation">(</span><span class="token parameter">act</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">let</span> nowTime <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
    url<span class="token punctuation">:</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">,</span>
    act<span class="token punctuation">:</span> act<span class="token punctuation">,</span>
    duration<span class="token punctuation">:</span> <span class="token punctuation">(</span>act <span class="token operator">==</span> <span class="token string">'open'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>nowTime <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key<span class="token punctuation">:</span> key<span class="token punctuation">,</span>
    m<span class="token punctuation">:</span> nowTime
  <span class="token punctuation">}</span>
  <span class="token function">sendImg</span><span class="token punctuation">(</span>baseApi <span class="token operator">+</span> <span class="token string">'logs/auto'</span> <span class="token operator">+</span> <span class="token function">formatParams</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span>act <span class="token operator">==</span> <span class="token string">'open'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>startTime <span class="token operator">=</span> nowTime<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 没有找到办法区分是刷新、跳转还是关闭</span>
<span class="token comment">// 这里就先只有打开和关闭。以后再想办法</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">sendAuto</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">)</span>
  window<span class="token punctuation">.</span><span class="token function-variable function">onbeforeunload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendAuto</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="埋点功能"><a href="#埋点功能" aria-hidden="true" class="header-anchor">#</a> 埋点功能</h3> <p>我们定义一个全局的数组变量<code>_sdkLog</code></p> <blockquote><p>参数</p> <ul><li><code>url</code>：页面地址</li> <li><code>type</code>：页面类型（<code>app</code>、<code>wechat</code>、<code>qq</code>、<code>openweb</code>）</li> <li><code>act</code>：活动或页面功能名</li> <li><code>op</code>：用户操作行为</li> <li><code>tag</code>：用户操作行为的附加信息，如有多条，使用<code>|</code>分割</li> <li><code>key</code>：产品代号</li> <li><code>m</code>：相同地址的图片会有缓存，为保证每次都能发出请求，多加一个参数。用随机数或者当前时间</li></ul></blockquote> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// html文件</span>
<span class="token keyword">var</span> _sdkLog <span class="token operator">=</span> _sdkLog <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> sdk <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;script&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  sdk<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;http://xxx/sdkLog.js?key=xxxxxxxxxxxxx&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> s <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">&quot;script&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
  s<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>sdk<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment">// sdkLog.js文件</span>
<span class="token keyword">function</span> <span class="token function">sendPoint</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
    url<span class="token punctuation">:</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">,</span>
    type<span class="token punctuation">:</span> <span class="token function">getBrowserType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    act<span class="token punctuation">:</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">?</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    op<span class="token punctuation">:</span> arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">?</span> arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    tag<span class="token punctuation">:</span> arr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">?</span> arr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    key<span class="token punctuation">:</span> key<span class="token punctuation">,</span>
    m<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    params<span class="token punctuation">.</span>tag <span class="token operator">=</span> params<span class="token punctuation">.</span>tag<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">sendImg</span><span class="token punctuation">(</span>baseApi <span class="token operator">+</span> <span class="token string">'logs/point'</span> <span class="token operator">+</span> <span class="token function">formatParams</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 开放一个方法用于埋点</span>
<span class="token keyword">let</span> logHistory <span class="token operator">=</span> window<span class="token punctuation">.</span>_sdkLog <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
window<span class="token punctuation">.</span>_sdkLog <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">push</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> arg <span class="token operator">=</span> arguments<span class="token punctuation">[</span>k<span class="token punctuation">]</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logHistory<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
        <span class="token function">sendPoint</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// 埋点代码示例</span>
_sdkLog<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'帖子编辑框'</span><span class="token punctuation">,</span> <span class="token string">'插入表情'</span><span class="token punctuation">,</span> <span class="token string">'附加信息1|附加信息2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
_sdkLog<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'帖子编辑框'</span><span class="token punctuation">,</span> <span class="token string">'插入表情'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
_sdkLog<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'帖子编辑框'</span><span class="token punctuation">,</span> <span class="token string">'插入表情'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'附加信息1'</span><span class="token punctuation">,</span> <span class="token string">'附加信息2'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h3 id="开放方法"><a href="#开放方法" aria-hidden="true" class="header-anchor">#</a> 开放方法</h3> <p>单页面应用等，当页面跳转时，没法监测到页面变动。</p> <p><strong>方法一（不推荐）</strong>
开放几个方法，单页面应用可以自行添加</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// sdkLog.js文件</span>
<span class="token comment">// 提供给全局的方法</span>
window<span class="token punctuation">.</span>$sdkLog <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendAuto</span><span class="token punctuation">(</span><span class="token string">'redirection'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendAuto</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendAuto</span><span class="token punctuation">(</span><span class="token string">'refresh'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>方法二（推荐）</strong>
借鉴百度统计功能，不用上面的几个方法
通过给<code>_sdkLog</code>进行<code>push</code>操作的时候带不同的参数来实现埋点和页面跳转
埋点操作<code>_trackEvent</code>、页面跳转<code>_trackPageview</code></p> <p>具体代码如下：修改<code>window._sdkLog</code>部分</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> logHistory <span class="token operator">=</span> window<span class="token punctuation">.</span>_sdkLog <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
window<span class="token punctuation">.</span>_sdkLog <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">push</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> arg <span class="token operator">=</span> arguments<span class="token punctuation">[</span>k<span class="token punctuation">]</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> arg<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">case</span> <span class="token string">'_setAutoPageview'</span><span class="token punctuation">:</span>
            autoPageview <span class="token operator">=</span> arg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token punctuation">:</span> <span class="token boolean">false</span>
            <span class="token keyword">break</span>
          <span class="token keyword">case</span> <span class="token string">'_trackPageview'</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'open'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">sendAuto</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'redirect'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">sendAuto</span><span class="token punctuation">(</span><span class="token string">'redirection'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'refresh'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">sendAuto</span><span class="token punctuation">(</span><span class="token string">'refresh'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span>
          <span class="token keyword">case</span> <span class="token string">'_trackEvent'</span><span class="token punctuation">:</span>
            arg<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            logHistory<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
            <span class="token function">sendPoint</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// 埋点代码示例</span>
_sdkLog<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'_trackEvent'</span><span class="token punctuation">,</span> <span class="token string">'帖子编辑框'</span><span class="token punctuation">,</span> <span class="token string">'插入表情'</span><span class="token punctuation">,</span> <span class="token string">'附加信息1|附加信息2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
_sdkLog<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'_trackEvent'</span><span class="token punctuation">,</span> <span class="token string">'帖子编辑框'</span><span class="token punctuation">,</span> <span class="token string">'插入表情'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
_sdkLog<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'_trackEvent'</span><span class="token punctuation">,</span> <span class="token string">'帖子编辑框'</span><span class="token punctuation">,</span> <span class="token string">'插入表情'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'附加信息1'</span><span class="token punctuation">,</span> <span class="token string">'附加信息2'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// 页面跳转代码示例</span>
_sdkLog<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'_trackPageview'</span><span class="token punctuation">,</span> <span class="token string">'open'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
_sdkLog<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'_trackPageview'</span><span class="token punctuation">,</span> <span class="token string">'redirect'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
_sdkLog<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'_trackPageview'</span><span class="token punctuation">,</span> <span class="token string">'refresh'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h3 id="压缩混淆"><a href="#压缩混淆" aria-hidden="true" class="header-anchor">#</a> 压缩混淆</h3> <p><code>sdkLog.js</code>文件需要进行压缩混淆
代码中使用的一些<code>ES6/7/8</code>语法需要转成<code>ES5</code>语法
这里我们使用<code>webpack + babel</code>做简单处理</p> <ul><li><code>npm init -y</code></li> <li>安装：<code>npm i webpack webpack-cli webpack-dev-server babel-core babel-loader babel-preset-env html-webpack-plugin cross-env --save-dev</code></li> <li>新建文件<code>webpack.config.js</code></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token comment">// const htmlWebpackPlugin = require('html-webpack-plugin')</span>

<span class="token comment">// 导出一个具有特殊属性配置的对象</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token punctuation">:</span><span class="token string">'./src/main.js'</span><span class="token punctuation">,</span><span class="token comment">/* 入口文件模块路径 */</span>
  output<span class="token punctuation">:</span><span class="token punctuation">{</span>
    path<span class="token punctuation">:</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'./dist/'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">/* 出口文件模块所属目录，必须是一个绝对路径 */</span>
    filename<span class="token punctuation">:</span><span class="token string">'sdkLog.js'</span><span class="token comment">/* 打包的结果文件名称 */</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// devServer:{</span>
  <span class="token comment">//   // 配置webpack-dev-server的www目录</span>
  <span class="token comment">//   host: 'localhost',</span>
  <span class="token comment">//   port: 8080,</span>
  <span class="token comment">//   contentBase:'./dist'</span>
  <span class="token comment">// },</span>
  plugins<span class="token punctuation">:</span><span class="token punctuation">[</span>
    <span class="token comment">// 该插件可以把index.html打包到bundle.js文件所属目录，跟着bundle走</span>
    <span class="token comment">// 同时也会自动在index.html中注入script引用链接，并且引用的资源名称，也取决于打包的文件名称</span>
    <span class="token comment">// new htmlWebpackPlugin({</span>
    <span class="token comment">//   template:'./index.html'</span>
    <span class="token comment">// })</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  module<span class="token punctuation">:</span><span class="token punctuation">{</span>
    rules<span class="token punctuation">:</span><span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token punctuation">:</span><span class="token regex">/\.js$/</span><span class="token punctuation">,</span>
        exclude<span class="token punctuation">:</span><span class="token regex">/(node_modules)/</span><span class="token punctuation">,</span><span class="token comment">//排除掉node_module目录</span>
        use<span class="token punctuation">:</span><span class="token punctuation">{</span>
          loader<span class="token punctuation">:</span><span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
          options<span class="token punctuation">:</span><span class="token punctuation">{</span>
            presets<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'env'</span><span class="token punctuation">]</span> <span class="token comment">//转码规则</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><ul><li>修改<code>package.json</code>文件，添加一条命令<code>&quot;build&quot;: &quot;cross-env webpack --config webpack.config.js --progress&quot;</code></li> <li>执行<code>npm run build</code>，即可在<code>dist/</code>目录打包生成压缩混淆后的<code>sdkLog.js</code>文件</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.373ebcd7.js" defer></script><script src="/assets/js/3.bfdcfffd.js" defer></script><script src="/assets/js/46.15edd465.js" defer></script>
  </body>
</html>
