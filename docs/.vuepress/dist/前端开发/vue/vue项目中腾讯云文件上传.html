<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue项目中腾讯云文件上传 | 喵巨人笔记</title>
    <meta name="description" content="在vue项目中上传文件到腾讯云对象存储">
    <link rel="icon" href="/favicon.ico">
    <meta name="keywords" content="喵巨人,前端,笔记,vue,文件上传,腾讯云">
    <link rel="preload" href="/assets/css/0.styles.737906f3.css" as="style"><link rel="preload" href="/assets/js/app.373ebcd7.js" as="script"><link rel="preload" href="/assets/js/3.bfdcfffd.js" as="script"><link rel="preload" href="/assets/js/61.044fc743.js" as="script"><link rel="prefetch" href="/assets/js/1.2bae9d15.js"><link rel="prefetch" href="/assets/js/10.c7e5de1e.js"><link rel="prefetch" href="/assets/js/11.947faf55.js"><link rel="prefetch" href="/assets/js/12.2472fbdd.js"><link rel="prefetch" href="/assets/js/13.9e618bf6.js"><link rel="prefetch" href="/assets/js/14.0356e7d9.js"><link rel="prefetch" href="/assets/js/15.3c111c61.js"><link rel="prefetch" href="/assets/js/16.b9482d17.js"><link rel="prefetch" href="/assets/js/17.98b647f1.js"><link rel="prefetch" href="/assets/js/18.76c49e99.js"><link rel="prefetch" href="/assets/js/19.1c20d10f.js"><link rel="prefetch" href="/assets/js/20.dc70c8fc.js"><link rel="prefetch" href="/assets/js/21.467ebb2d.js"><link rel="prefetch" href="/assets/js/22.b0a1d0f3.js"><link rel="prefetch" href="/assets/js/23.b00a4bf6.js"><link rel="prefetch" href="/assets/js/24.ca272cf3.js"><link rel="prefetch" href="/assets/js/25.14adbaf7.js"><link rel="prefetch" href="/assets/js/26.f97564e3.js"><link rel="prefetch" href="/assets/js/27.8e4bdef8.js"><link rel="prefetch" href="/assets/js/28.82f93745.js"><link rel="prefetch" href="/assets/js/29.987f527d.js"><link rel="prefetch" href="/assets/js/30.b00d5021.js"><link rel="prefetch" href="/assets/js/31.0373fca1.js"><link rel="prefetch" href="/assets/js/32.f4b40012.js"><link rel="prefetch" href="/assets/js/33.befd342c.js"><link rel="prefetch" href="/assets/js/34.db1e4f82.js"><link rel="prefetch" href="/assets/js/35.738f4fb7.js"><link rel="prefetch" href="/assets/js/36.06c6d04e.js"><link rel="prefetch" href="/assets/js/37.984d486d.js"><link rel="prefetch" href="/assets/js/38.b68b4bc8.js"><link rel="prefetch" href="/assets/js/39.58b551b7.js"><link rel="prefetch" href="/assets/js/4.730b44f6.js"><link rel="prefetch" href="/assets/js/40.e430db82.js"><link rel="prefetch" href="/assets/js/41.e9743d5e.js"><link rel="prefetch" href="/assets/js/42.3971888d.js"><link rel="prefetch" href="/assets/js/43.656a7310.js"><link rel="prefetch" href="/assets/js/44.9fa3cf39.js"><link rel="prefetch" href="/assets/js/45.cd770c5b.js"><link rel="prefetch" href="/assets/js/46.15edd465.js"><link rel="prefetch" href="/assets/js/47.3e4c8435.js"><link rel="prefetch" href="/assets/js/48.20578371.js"><link rel="prefetch" href="/assets/js/49.16e33620.js"><link rel="prefetch" href="/assets/js/5.34ad1117.js"><link rel="prefetch" href="/assets/js/50.342ff260.js"><link rel="prefetch" href="/assets/js/51.521f5e9b.js"><link rel="prefetch" href="/assets/js/52.6a76ec0a.js"><link rel="prefetch" href="/assets/js/53.69444c3a.js"><link rel="prefetch" href="/assets/js/54.07b58fd5.js"><link rel="prefetch" href="/assets/js/55.8f53b56c.js"><link rel="prefetch" href="/assets/js/56.19c3bd08.js"><link rel="prefetch" href="/assets/js/57.73b77cef.js"><link rel="prefetch" href="/assets/js/58.736d163d.js"><link rel="prefetch" href="/assets/js/59.260f8893.js"><link rel="prefetch" href="/assets/js/6.7846ba7f.js"><link rel="prefetch" href="/assets/js/60.31913508.js"><link rel="prefetch" href="/assets/js/62.e1cdd68a.js"><link rel="prefetch" href="/assets/js/63.46360f15.js"><link rel="prefetch" href="/assets/js/64.97176203.js"><link rel="prefetch" href="/assets/js/65.2103cfda.js"><link rel="prefetch" href="/assets/js/66.9a7763c9.js"><link rel="prefetch" href="/assets/js/67.1c1bc12c.js"><link rel="prefetch" href="/assets/js/68.ec583a59.js"><link rel="prefetch" href="/assets/js/69.dc6b9224.js"><link rel="prefetch" href="/assets/js/7.2d505d86.js"><link rel="prefetch" href="/assets/js/70.6720396d.js"><link rel="prefetch" href="/assets/js/71.649f88b5.js"><link rel="prefetch" href="/assets/js/72.fd020fed.js"><link rel="prefetch" href="/assets/js/73.1a58133e.js"><link rel="prefetch" href="/assets/js/74.ce0c5fdf.js"><link rel="prefetch" href="/assets/js/75.10bc575a.js"><link rel="prefetch" href="/assets/js/76.c28e2c30.js"><link rel="prefetch" href="/assets/js/77.4fecac7f.js"><link rel="prefetch" href="/assets/js/78.35acfd0c.js"><link rel="prefetch" href="/assets/js/79.8d634081.js"><link rel="prefetch" href="/assets/js/8.80a2de5f.js"><link rel="prefetch" href="/assets/js/80.fc226694.js"><link rel="prefetch" href="/assets/js/81.ae543107.js"><link rel="prefetch" href="/assets/js/82.336196da.js"><link rel="prefetch" href="/assets/js/83.92783483.js"><link rel="prefetch" href="/assets/js/84.6b5d6b7b.js"><link rel="prefetch" href="/assets/js/85.96cb4fa9.js"><link rel="prefetch" href="/assets/js/86.ccb3db59.js"><link rel="prefetch" href="/assets/js/87.dd5a823e.js"><link rel="prefetch" href="/assets/js/9.e7a537d5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.737906f3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">喵巨人笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端开发</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/前端开发/css/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/前端开发/javascript/" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/前端开发/vue/" class="nav-link">vue</a></li><li class="dropdown-item"><!----> <a href="/前端开发/nuxt/" class="nav-link">nuxt</a></li><li class="dropdown-item"><!----> <a href="/前端开发/插件/" class="nav-link">插件</a></li><li class="dropdown-item"><!----> <a href="/前端开发/other/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><a href="/php/" class="nav-link">php</a></div><div class="nav-item"><a href="/linux/" class="nav-link">linux</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/其他/Markdown简介.html" class="nav-link">Markdown简介</a></li></ul></div></div><div class="nav-item"><a href="/关于作者.html" class="nav-link">关于</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端开发</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/前端开发/css/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/前端开发/javascript/" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/前端开发/vue/" class="nav-link">vue</a></li><li class="dropdown-item"><!----> <a href="/前端开发/nuxt/" class="nav-link">nuxt</a></li><li class="dropdown-item"><!----> <a href="/前端开发/插件/" class="nav-link">插件</a></li><li class="dropdown-item"><!----> <a href="/前端开发/other/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><a href="/php/" class="nav-link">php</a></div><div class="nav-item"><a href="/linux/" class="nav-link">linux</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/其他/Markdown简介.html" class="nav-link">Markdown简介</a></li></ul></div></div><div class="nav-item"><a href="/关于作者.html" class="nav-link">关于</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vue项目中腾讯云文件上传</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/vue/vue%E9%A1%B9%E7%9B%AE%E4%B8%AD%E8%85%BE%E8%AE%AF%E4%BA%91%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0.html#简介" class="sidebar-link">简介</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/vue/vue%E9%A1%B9%E7%9B%AE%E4%B8%AD%E8%85%BE%E8%AE%AF%E4%BA%91%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0.html#准备" class="sidebar-link">准备</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/vue/vue%E9%A1%B9%E7%9B%AE%E4%B8%AD%E8%85%BE%E8%AE%AF%E4%BA%91%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0.html#步骤" class="sidebar-link">步骤</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/vue/vue%E9%A1%B9%E7%9B%AE%E4%B8%AD%E8%85%BE%E8%AE%AF%E4%BA%91%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/vue/vue%E9%A1%B9%E7%9B%AE%E4%B8%AD%E8%85%BE%E8%AE%AF%E4%BA%91%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0.html#使用" class="sidebar-link">使用</a></li></ul></li><li><a href="/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/vue/vue%E9%A1%B9%E7%9B%AE%E4%B8%AD%E8%85%BE%E8%AE%AF%E4%BA%91%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0.html#参考链接" class="sidebar-link">参考链接</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue项目中腾讯云文件上传"><a href="#vue项目中腾讯云文件上传" aria-hidden="true" class="header-anchor">#</a> Vue项目中腾讯云文件上传</h1> <h2 id="简介"><a href="#简介" aria-hidden="true" class="header-anchor">#</a> 简介</h2> <p>文件上传一般是前端将文件通过<code>form表单</code>或者<code>ajax</code>提交给后端</p> <p>这里介绍前端直接上传文件到腾讯云的对象存储中</p> <p>小文件直接上传，大文件用分片上传的方式。</p> <p>文件分片上传需要一个识别文件的唯一标识。而<code>md5</code>是非常合适的，前端在文件上传前在本地使用<code>spark-md5</code>计算<code>md5</code></p> <h2 id="准备"><a href="#准备" aria-hidden="true" class="header-anchor">#</a> 准备</h2> <ul><li>注册腾讯云账号</li> <li>到<code>COS对象存储控制台</code>创建存储桶，得到<code>Bucket</code>（存储桶名称）和<code>Region</code>（地域名称）</li> <li>到<code>控制台密钥管理</code>获取项目的<code>SecretId</code>和<code>SecretKey</code></li></ul> <h2 id="步骤"><a href="#步骤" aria-hidden="true" class="header-anchor">#</a> 步骤</h2> <h3 id="安装"><a href="#安装" aria-hidden="true" class="header-anchor">#</a> 安装</h3> <ul><li>安装：<code>npm i cos-js-sdk-v5 spark-md5 --save</code></li></ul> <h3 id="使用"><a href="#使用" aria-hidden="true" class="header-anchor">#</a> 使用</h3> <ul><li>在<code>config/dev.env.js</code>和<code>config/prod.env.js</code>文件中添加相关配置</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  Bucket<span class="token punctuation">:</span> <span class="token string">'&quot;xxx-xxx-xxx&quot;'</span><span class="token punctuation">,</span> <span class="token comment">// Bucket</span>
  Region<span class="token punctuation">:</span> <span class="token string">'&quot;ap-beijing&quot;'</span><span class="token punctuation">,</span> <span class="token comment">// Region</span>
  Domain<span class="token punctuation">:</span><span class="token string">'&quot;xxx.xxx.com&quot;'</span><span class="token punctuation">,</span>  <span class="token comment">// Domain</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>在<code>src/utils/</code>目录下新建文件<code>uploadfile.js</code></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token constant">COS</span> <span class="token keyword">from</span> <span class="token string">'cos-js-sdk-v5'</span>
<span class="token keyword">import</span> SparkMD5 <span class="token keyword">from</span> <span class="token string">'spark-md5'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getCOSAuth <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/axios/api'</span>

<span class="token keyword">var</span> key <span class="token operator">=</span> <span class="token string">''</span>
<span class="token comment">// 配置</span>
<span class="token keyword">const</span> cosConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  Bucket<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>Bucket<span class="token punctuation">,</span>
  Region<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>Region<span class="token punctuation">,</span>
  Domain<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>Domain
<span class="token punctuation">}</span>

<span class="token comment">// 初始化实例</span>
<span class="token keyword">var</span> cos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">COS</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">getAuthorization</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 签名计算放在前端会暴露 SecretId 和 SecretKey
     * 我们把签名计算过程放在后端实现，前端通过 ajax 向后端获取签名结果
     * 正式部署时请再后端加一层自己网站本身的权限检验。 
     * 异步获取临时密钥
     */</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getCOSAuth</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> authdata <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>response
    <span class="token keyword">const</span> auth <span class="token operator">=</span> <span class="token punctuation">{</span>
      TmpSecretId<span class="token punctuation">:</span> authdata<span class="token punctuation">.</span>credentials<span class="token punctuation">.</span>tmpSecretId<span class="token punctuation">,</span>
      TmpSecretKey<span class="token punctuation">:</span> authdata<span class="token punctuation">.</span>credentials<span class="token punctuation">.</span>tmpSecretKey<span class="token punctuation">,</span>
      XCosSecurityToken<span class="token punctuation">:</span> authdata<span class="token punctuation">.</span>credentials<span class="token punctuation">.</span>sessionToken<span class="token punctuation">,</span>
      ExpiredTime<span class="token punctuation">:</span> authdata<span class="token punctuation">.</span>expiredTime <span class="token comment">// 在ExpiredTime时间前，不会再次调用getAuthorization</span>
    <span class="token punctuation">}</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  FileParallelLimit<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// 文件并发数</span>
  ChunkParallelLimit<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// 同一个上传文件的分块并发数</span>
  ChunkSize<span class="token punctuation">:</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token comment">// 分块上传时，每块的字节数大小</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 获取cos存储的图片地址，替换为域名地址</span>
<span class="token keyword">function</span> <span class="token function">getObjectUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> cos<span class="token punctuation">.</span><span class="token function">getObjectUrl</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    Bucket<span class="token punctuation">:</span> cosConfig<span class="token punctuation">.</span>Bucket<span class="token punctuation">,</span>
    Region<span class="token punctuation">:</span> cosConfig<span class="token punctuation">.</span>Region<span class="token punctuation">,</span>
    Key<span class="token punctuation">:</span> key<span class="token punctuation">,</span>
    Sign<span class="token punctuation">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log(err || data)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 腾讯云的地址替换为域名地址</span>
  <span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cosConfig<span class="token punctuation">.</span>Bucket<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.cos.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cosConfig<span class="token punctuation">.</span>Region<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.myqcloud.com</span><span class="token template-punctuation string">`</span></span>
  <span class="token keyword">return</span> url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> cosConfig<span class="token punctuation">.</span>Domain<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获得文件md5</span>
<span class="token keyword">function</span> <span class="token function">getFileMD5</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 声明必要的变量</span>
  <span class="token keyword">const</span> fileReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 文件每块分割2M，计算分割详情</span>
  <span class="token keyword">const</span> chunkSize <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> chunks <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>size <span class="token operator">/</span> chunkSize<span class="token punctuation">)</span>
  <span class="token keyword">let</span> currentChunk <span class="token operator">=</span> <span class="token number">0</span>

  <span class="token comment">// 创建md5对象（基于SparkMD5）</span>
  <span class="token keyword">const</span> spark <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkMD5</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// 每块文件读取完毕之后的处理</span>
  fileReader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 每块交由sparkMD5进行计算</span>
    spark<span class="token punctuation">.</span><span class="token function">appendBinary</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">)</span>
    currentChunk<span class="token operator">++</span>

    <span class="token comment">// 如果文件处理完成计算MD5，如果还有分片继续处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentChunk <span class="token operator">&lt;</span> chunks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">loadNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>spark<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 处理单片文件的上传</span>
  <span class="token keyword">function</span> <span class="token function">loadNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> start <span class="token operator">=</span> currentChunk <span class="token operator">*</span> chunkSize
    <span class="token keyword">const</span> end <span class="token operator">=</span> start <span class="token operator">+</span> chunkSize <span class="token operator">&gt;=</span> file<span class="token punctuation">.</span>size <span class="token operator">?</span> file<span class="token punctuation">.</span>size <span class="token punctuation">:</span> start <span class="token operator">+</span> chunkSize

    fileReader<span class="token punctuation">.</span><span class="token function">readAsBinaryString</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">loadNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 大文件分片上传-通过sliceUploadFile上传</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> progressBc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 得到md5码</span>
  <span class="token function">getFileMD5</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token parameter">md5</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 存储文件的md5码</span>
    file<span class="token punctuation">.</span>md5 <span class="token operator">=</span> md5
    <span class="token keyword">const</span> subfix <span class="token operator">=</span> file<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    key <span class="token operator">=</span> file<span class="token punctuation">.</span>md5 <span class="token operator">+</span> subfix<span class="token punctuation">;</span>
    cos<span class="token punctuation">.</span><span class="token function">sliceUploadFile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      Bucket<span class="token punctuation">:</span> cosConfig<span class="token punctuation">.</span>Bucket<span class="token punctuation">,</span>
      Region<span class="token punctuation">:</span> cosConfig<span class="token punctuation">.</span>Region<span class="token punctuation">,</span>
      Key<span class="token punctuation">:</span> key<span class="token punctuation">,</span>
      Body<span class="token punctuation">:</span> file<span class="token punctuation">,</span>
      <span class="token function-variable function">onProgress</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">progressData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">progressBc</span><span class="token punctuation">(</span>progressData<span class="token punctuation">.</span>percent<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">.</span>fid <span class="token operator">=</span> <span class="token function">getObjectUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 小文件直接上传-通过putObject上传</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">uploadFile2</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> progressBc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 得到md5码</span>
  <span class="token function">getFileMD5</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token parameter">md5</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 存储文件的md5码</span>
    file<span class="token punctuation">.</span>md5 <span class="token operator">=</span> md5
    <span class="token keyword">const</span> subfix <span class="token operator">=</span> file<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    key <span class="token operator">=</span> file<span class="token punctuation">.</span>md5 <span class="token operator">+</span> subfix
    cos<span class="token punctuation">.</span><span class="token function">headObject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      Bucket<span class="token punctuation">:</span> cosConfig<span class="token punctuation">.</span>Bucket<span class="token punctuation">,</span>
      Region<span class="token punctuation">:</span> cosConfig<span class="token punctuation">.</span>Region<span class="token punctuation">,</span>
      Key<span class="token punctuation">:</span> key
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cos<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          Bucket<span class="token punctuation">:</span> cosConfig<span class="token punctuation">.</span>Bucket<span class="token punctuation">,</span>
          Region<span class="token punctuation">:</span> cosConfig<span class="token punctuation">.</span>Region<span class="token punctuation">,</span>
          Key<span class="token punctuation">:</span> key<span class="token punctuation">,</span>
          Body<span class="token punctuation">:</span> file<span class="token punctuation">,</span>
          <span class="token function-variable function">onProgress</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">progressData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// console.log(JSON.stringify(info))</span>
            <span class="token function">progressBc</span><span class="token punctuation">(</span>progressData<span class="token punctuation">.</span>percent<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&amp;&amp;</span> err<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// wx.showModal({ title: '返回错误', content: '请求失败：' + err.error.Message + '；状态码：' + err.statusCode, showCancel: false });</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// wx.showModal({ title: '请求出错', content: '请求出错：' + err + '；状态码：' + err.statusCode, showCancel: false });</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">callback</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
            <span class="token comment">//  wx.showToast({ title: '上传成功', icon: 'success', duration: 3000 });</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callback</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br></div></div><ul><li>组件中使用</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> uploadFile <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/utils/uploadfile'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'file-selector'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onchange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> file <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">)</span> <span class="token keyword">return</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cosUploadFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过腾讯云 cos-js-sdk-v5 上传</span>
    <span class="token function">cosUploadFile</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
      <span class="token function">uploadFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          that<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'getUploadFiles'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h2 id="参考链接"><a href="#参考链接" aria-hidden="true" class="header-anchor">#</a> 参考链接</h2> <ul><li><a href="https://github.com/tencentyun/cos-js-sdk-v5" target="_blank" rel="noopener noreferrer">cos-js-sdk-v5<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.npmjs.com/package/spark-md5" target="_blank" rel="noopener noreferrer">spark-md5<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.373ebcd7.js" defer></script><script src="/assets/js/3.bfdcfffd.js" defer></script><script src="/assets/js/61.044fc743.js" defer></script>
  </body>
</html>
